<div class="custom-table">
  <div class="text-end mt-3">
    <button class="btn btn-primary" (click)="openPaymentModal()">Make Payment</button>
  </div>

  <table #table class="table">
    <thead>
      <tr class="table-light;justify-content-between">
        <th>Select</th>
        <th>Invoice Date</th>
        <th>Invoice No</th>
        <th>Vendor Name</th>
        <th>Due Date</th>
        <th>Total Amount </th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let bilti of biltisList; let i = index; trackBy: trackByFn">
        <td class="">
          <input type="checkbox" [(ngModel)]="bilti.isSelected" (change)="calculateForAllInvoices()" />
        </td>
        <td>{{ bilti?.invoiceDate | date:'dd-MM-yyyy' }}</td>
        <td>{{ bilti?.clientInvoiceNo || '-' }}</td>
        <td>{{ bilti?.vendorDetails.vendorName || '-' }}</td>
        <td>{{ bilti?.dueDateAsPerInvoice | date:'dd-MM-yyyy' }}</td>
        <td>{{ bilti?.totalAmount || 0 | number:'1.2-2' }}</td>
      </tr>
      <tr *ngIf="biltisList.length === 0">
        <td colspan="8" class="text-center">No Biltis Found</td>
      </tr>
    </tbody>
  </table>
</div>
<ng-template #paymentModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Payment Details</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="paymentForm">
      <div class="mb-3 p-2 bg-light rounded d-flex ">
        <span class="fw-bold text-dark">ðŸ’° Total Selected Invoice Amount:</span>
        <span class="fw-bold text-danger ms-2">
          {{ selectedInvoicesTotal | number:'1.2-2' }}
        </span>
      </div>

      <div class="row g-2">
        
        <div class="col-md-4">
          <label>Payment Type <span class="text-danger">*</span></label>
          <ng-select formControlName="paymentType" [items]="paymentTypes" bindLabel="name" bindValue="value"
            placeholder="Select Type" (change)="onPaymentTypeChange()">
          </ng-select>
        </div>
        
        <div class="col-md-4">
          <label>Payment Date <span class="text-danger">*</span></label>
          <div class="input-group datepicker">
            <input class="form-control" placeholder="dd-MM-yyyy" formControlName="paymentDate" ngbDatepicker
              #dp="ngbDatepicker" readonly />
            <button class="btn btn-outline-secondary" (click)="dp.toggle()" type="button">
              <img src="assets/images/icons/calendar.svg" width="15px" />
            </button>
          </div>
        </div>

        <div class="col-md-4">
          <label>Bank <span class="text-danger">*</span></label>
          <ng-select formControlName="bankID" [items]="transactionTypesList" bindLabel="bankName" bindValue="id"
            placeholder="Select Bank">
          </ng-select>
        </div>

        <div class="col-md-4">
          <label>Currency <span class="text-danger">*</span></label>
          <ng-select formControlName="paymentCurrency" [items]="currencyList" bindLabel="value" bindValue="value"
            placeholder="Select Currency">
          </ng-select>
        </div>

        <div class="col-md-4">
          <label>OWRM No <span class="text-danger">*</span></label>
          <input formControlName="owrmNo1" type="text" class="form-control" placeholder="OWRM No" />
        </div>
        
        <div class="col-md-4">
          <label>Forex Amount <span class="text-danger" *ngIf="paymentForm.get('paymentType')?.value === 'full'">*</span></label>
          <input formControlName="rate" type="number" class="form-control" min="0" (keypress)="validateDecimal($event)"
            (input)="calculateAmounts()" [readonly]="paymentForm.get('paymentType')?.value === 'partial'"
            [ngClass]="{'bg-light': paymentForm.get('paymentType')?.value === 'partial'}" />
        </div>

        <div class="col-md-4">
          <label>Rate Of Exchange <span class="text-danger">*</span></label>
          <input formControlName="quantity" type="number" class="form-control" min="1" (input)="calculateAmounts()" />
        </div>

        <div class="col-md-4">
          <label>Bank Charges <span class="text-danger" *ngIf="paymentForm.get('paymentType')?.value === 'full'">*</span></label>
          <input formControlName="bankCharges" type="number" class="form-control" (keypress)="validateDecimal($event)"
            (input)="calculateAmounts()" [readonly]="paymentForm.get('paymentType')?.value === 'partial'"
            [ngClass]="{'bg-light': paymentForm.get('paymentType')?.value === 'partial'}" />
        </div>
      </div>

     <div class="mt-4">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>Invoice No</th>
              <th>Total Invoice Amount</th>
              
              <th *ngIf="paymentForm.get('paymentType')?.value === 'partial'">Payment Amount (Max: {{selectedInvoicesTotal | number:'1.2-2'}}) <span class="text-danger">*</span></th>
              
              <th *ngIf="paymentForm.get('paymentType')?.value === 'partial'">Bank Charges (User Input) <span class="text-danger">*</span></th>
              
              <th *ngIf="paymentForm.get('paymentType')?.value === 'full'">Bank Charges (Distributed)</th>
              
              <th>Total Amount (INR)</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let invoice of biltisList" [hidden]="!invoice.isSelected">
              <td>{{ invoice.clientInvoiceNo }}</td>
              <td>{{ invoice.totalAmount | number:'1.2-2' }}</td>
              
              <td *ngIf="paymentForm.get('paymentType')?.value === 'partial'">
                <input type="number" class="form-control form-control-sm" [(ngModel)]="invoice.partialAmount"
                  [ngModelOptions]="{standalone: true}" min="0" 
                  [max]="invoice.totalAmount"
                  (keypress)="validateDecimal($event)"
                  (input)="calculatePartialAmounts(invoice)" />
              </td>
              
              <td *ngIf="paymentForm.get('paymentType')?.value === 'partial'">
                <input type="number" class="form-control form-control-sm" [(ngModel)]="invoice.partialBankCharges"
                  [ngModelOptions]="{standalone: true}" min="0" 
                  (keypress)="validateDecimal($event)"
                  (input)="calculatePartialAmounts(invoice)" />
              </td>
              
              <td *ngIf="paymentForm.get('paymentType')?.value === 'full'">
                {{ invoice.calculatedBankCharges || 0 | number:'1.2-2' }}
              </td>
              
              <td>{{ invoice.calculatedTotalINR || 0 | number:'1.2-2' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <span class="text-danger me-auto" *ngIf="validationError">{{ validationError }}</span>
    <button class="btn btn-secondary" (click)="modal.dismiss()">Cancel</button>
    <button class="btn btn-primary" [disabled]="disableSubmit" (click)="submitPayment(); modal.close()">Submit</button>
  </div>
</ng-template>