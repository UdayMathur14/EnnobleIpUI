<div class="page-title">
  <h1>{{dispatchId > 0 ? 'Edit': 'Create'}} Vendor Invoice </h1>
  <div class="action-buttons">
    <button class="custom-button-regulr" (click)="onSavePress()">Save</button>
    <!-- [disabled]="isFormInvalid() -->
    <button class="custom-button-secondary" (click)="onCancelPress()">
      Cancel
    </button>
  </div>
</div>

<div class="content-section p-3">
  <form [formGroup]="addOrEditDispatchNoteFormGroup">
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#Tab1">Tab 1
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#Tab2">Tab 2
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#Tab3">Tab 3
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#Tab4">Tab 4
        </a>
      </li>
    </ul>

    <div class="tab-content">
      <div id="Tab1" class="tab-pane fade show active">
        <div class="row">
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Vendor Name</label>
              <ng-select [searchable]="true" formControlName="vendorId" [readonly]="dispatchId > 0"
                (change)="onVendorSelect($event)">
                <ng-option *ngFor="let vendor of vendorsList" [value]="vendor.id">
                  {{ vendor.vendorName }}
                </ng-option>
              </ng-select>
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Vendor Country </label>
              <input type="text" class="form-control" [value]="selectedVendorCountry" placeholder="Vendor country "
                readonly>
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Invoice Date</label>
              <div class="input-group datepicker">
                <input class="form-control" placeholder="yyyy-mm-dd" name="fromDt" [autoClose]="true"
                  formControlName="invoiceDate" (dateSelect)="onInvoiceDateChange($event)" ngbDatepicker
                  #fromDt="ngbDatepicker" readonly />
                <button class="btn btn-outline-secondary bi bi-calendar3" (click)="fromDt.toggle()" type="button">
                  <img src="assets/images/icons/calendar.svg" alt="" width="15px" />
                </button>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">FY</label>
              <input formControlName="fy" type="text" class="input-field" />
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for=""> Client Invoice No <span class="text-danger">*</span></label>
              <input formControlName="clientInvoiceNo" type="text" class="input-field" />
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Due Date As Per Invoice <span class="text-danger">*</span></label>
              <div class="input-group datepicker">
                <input class="form-control" placeholder="yyyy-mm-dd" name="dueDateAsPerInvoice" [autoClose]="true"
                  formControlName="dueDateAsPerInvoice" (dateSelect)="onDateSelect('dueDateAsPerInvoice', $event)"
                  ngbDatepicker #dueDateAsPerInvoice="ngbDatepicker" readonly />
                <button class="btn btn-outline-secondary bi bi-calendar3" (click)="dueDateAsPerInvoice.toggle()"
                  type="button">
                  <img src="assets/images/icons/calendar.svg" alt="" width="15px" />
                </button>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for=""> Credit Days As Per Contract </label>
              <input formControlName="creditDaysAsPerContract" type="number" class="input-field"
                (input)="onCreditDaysChange()" (keypress)="validateNo1($event)" />
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Due Date As Per Contract </label>
              <div class="input-group datepicker">
                <input class="form-control" placeholder="yyyy-mm-dd" name="dueDateAsPerContract"
                  formControlName="dueDateAsPerContract" readonly />
                <button class="btn btn-outline-secondary bi bi-calendar3" type="button">
                  <img src="assets/images/icons/calendar.svg" alt="" width="15px" />
                </button>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Customer Name</label>
              <select formControlName="customerId" class="input-field">
                <option value="">Select Customer</option>
                <option *ngFor="let customers of customersList" [value]="customers.id">
                  {{ customers.customerName }}
                </option>
              </select>
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Description </label>
              <input formControlName="description" type="text" class="input-field" />
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Title </label>
              <input formControlName="title" type="text" class="input-field" />
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Application Number </label>
              <input formControlName="applicationNumber" type="text" class="input-field" />
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Filling Date </label>
              <div class="input-group datepicker">
                <input class="form-control" placeholder="yyyy-mm-dd" name="fillingDate" [autoClose]="true"
                  formControlName="fillingDate" (dateSelect)="onDateSelect('fillingDate', $event)" ngbDatepicker
                  #fillingDate="ngbDatepicker" readonly />
                <button class="btn btn-outline-secondary bi bi-calendar6" (click)="fillingDate.toggle()" type="button">
                  <img src="assets/images/icons/calendar.svg" alt="" width="15px" />
                </button>
              </div>

            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Client Ref No</label>
              <input formControlName="clientRefNo" type="text" class="input-field" />
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Our Ref No </label>
              <input formControlName="ourRefNo" type="text" class="input-field" />
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Filing Receipt Supporting</label>
              <ng-select [items]="[{ label: 'Yes', value: true }, { label: 'No', value: false }]" bindLabel="label"
                bindValue="value" formControlName="officialFilingReceiptSupporting" placeholder="Select Yes or No"
                class="input-field">
              </ng-select>
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Work Delivery Date Or Month</label>
              <div class="input-group datepicker">
                <input class="form-control" placeholder="yyyy-mm-dd" name="workDeliveryDateOrMonth" [autoClose]="true"
                  formControlName="workDeliveryDateOrMonth"
                  (dateSelect)="onDateSelect('workDeliveryDateOrMonth', $event)" ngbDatepicker
                  #workDeliveryDateOrMonthDt="ngbDatepicker" readonly />
                <button class="btn btn-outline-secondary bi bi-calendar3" (click)="workDeliveryDateOrMonthDt.toggle()"
                  type="button">
                  <img src="assets/images/icons/calendar.svg" alt="" width="15px" />
                </button>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Currency</label>
              <ng-select formControlName="currencyPID" class="input-field" placeholder="Select Currency">
                <ng-option *ngFor="let country of countryList" [value]="country.currencyName">
                  {{ country.currencyName }}
                </ng-option>
              </ng-select>
            </div>
          </div>
        </div>
      </div>

      <div id="Tab2" class="tab-pane fade">
        <div class="edit-screen-subTable mt-0">
          <h4>
            Fee Details
            <button (click)="createPartDetailsGroup()" class="custom-button-regulr">Add</button>
          </h4>
        </div>

        <div class="custom-table">
          <table>
            <thead class="table table-bordered">
              <tr>
                <th>Line</th>
                <th>Fees Type</th>
                <th>Type</th>
                <th>Country</th>
                <th *ngIf="isTranslationFeeSelected">Language</th>
                <th>Amount</th>
                <th>Remarks</th>
                <th class="text-center">Action</th>
              </tr>
            </thead>

            <tbody formArrayName="partdetails">
              <ng-container *ngFor="let vendorGroup of partDetails.controls; let ind = index">


                <tr formGroupName={{ind}}>

                  <td>{{ind+1}}</td>
                  <!-- Prof Fees -->
                  <td>
                    <div class="custom-form-input dispatchwidth">
                      <select class="form-control input-field" formControlName="feeType"
                        (change)="onFeeTypeSelect(getSelectedValue($event), ind)">
                        <option value="">Select Fee Type</option>
                        <option value="Professional Fee">Professional Fee</option>
                        <option value="Govt or Offical Fee">Govt or Offical Fee</option>
                        <option value="Other Charges">Other Charges</option>
                      </select>
                    </div>
                  </td>


                  <!-- SubItem -->

                  <td>
                    <div class="custom-form-input dispatchwidth">
                      <ng-select class="input-field" placeholder="Add Sub Fee" [items]="subFeeOptionsList[ind]"
                        bindLabel="value" bindValue="value" formControlName="subFeeValue"
                        (change)="onFeeTypeChange(ind)">
                      </ng-select>
                    </div>
                  </td>

                  <!-- Country -->

                  <td>
                    <div class="custom-form-input dispatchwidth">
                      <ng-select class="input-field" placeholder="Select Country" formControlName="country">
                        <ng-option *ngFor="let country of countryList" [value]="country.countryName">
                          {{ country.countryName }}
                        </ng-option>
                      </ng-select>
                    </div>
                  </td>

                  <td *ngIf="isTranslationFeeSelected">
                    <ng-container *ngIf="vendorGroup.get('subFeeValue')?.value === 'Translation Fee'; else emptyLang">
                      <div class="custom-form-input dispatchwidth">
                        <ng-select class="input-field" placeholder="Select Language" [items]="languageList"
                          bindLabel="name" bindValue="code" formControlName="language">
                        </ng-select>
                      </div>
                    </ng-container>
                    <ng-template #emptyLang>
                      <!-- empty cell to align columns -->
                    </ng-template>
                  </td>

                  <!-- Amount -->
                  <td>
                    <div class="custom-form-input dispatchwidthsmall">
                      <input formControlName="amount" class="input-field" type="number" placeholder="Enter Amt"
                        (keypress)="validateNo1($event)">
                    </div>
                  </td>

                  <!-- Remarks -->
                  <td>
                    <div class="custom-form-input dispatchwidth">
                      <input formControlName="remarks" type="text" class="input-field" placeholder="Remarks">
                    </div>
                  </td>

                  <!-- Action -->
                  <td class="text-center">
                    <img src="assets/images/icons/trash.svg" class="me-2 pointer" alt="Delete"
                      (click)="onDeletePartDetail(vendorGroup, ind)" />
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
        <!-- Totals Section -->
        <div class="row mt-4 gx-4 gy-3">
          <div class="col-lg-4 col-md-6">
            <div class="custom-form-input">
              <label class="fw-bold">Professional Fee Total Amount</label>
              <input formControlName="professionalFeeAmt" type="number" class="input-field form-control" readonly />
            </div>
          </div>

          <div class="col-lg-4 col-md-6">
            <div class="custom-form-input">
              <label class="fw-bold">Govt/Official Fee Total Amount</label>
              <input formControlName="govtOrOfficialFeeAmt" type="number" class="input-field form-control" readonly />
            </div>
          </div>

          <div class="col-lg-4 col-md-6">
            <div class="custom-form-input">
              <label class="fw-bold">Other Charges Total Amount</label>
              <input formControlName="otherChargesAmt" type="number" class="input-field form-control" readonly />
            </div>
          </div>

          <div class="col-lg-4 col-md-6">
            <div class="custom-form-input">
              <label class="fw-bold">Discount Amount</label>
              <input formControlName="discountAmt" type="number" class="input-field form-control"
                (keypress)="validateNo1($event)" />
            </div>
          </div>

          <div class="col-lg-4 col-md-6">
            <div class="custom-form-input">
              <label class="fw-bold">Discount CreditNote Amount</label>
              <input formControlName="discountCreditNoteAmt" type="number" class="input-field form-control"
                (keypress)="validateNo1($event)" />
            </div>
          </div>

          <div class="col-lg-4 col-md-6">
            <div class="custom-form-input">
              <label class="fw-bold">Total Amount</label>
              <input formControlName="TotalAmt" type="number" class="input-field form-control" readonly />
            </div>
          </div>
        </div>


      </div>

      <div id="Tab3" class="tab-pane fade show ">
        <div class="row">
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Payment Date</label>
              <!-- <input formControlName="paymentDate" type="text" class="input-field" /> -->
              <div class="input-group datepicker">
                <input class="form-control" placeholder="yyyy-mm-dd" name="paymentDate" [autoClose]="true"
                  formControlName="paymentDate" (dateSelect)="onDateSelect('paymentDate', $event)" ngbDatepicker
                  #paymentDate="ngbDatepicker" readonly />
                <button class="btn btn-outline-secondary bi bi-calendar3" (click)="paymentDate.toggle()" type="button">
                  <img src="assets/images/icons/calendar.svg" alt="" width="15px" />
                </button>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Bank Name</label>
              <ng-select formControlName="bankID" class="input-field" placeholder="Select Bank">
                <ng-option *ngFor="let bank of transactionTypesList" [value]="bank.id">
                  {{ bank.bankName }}
                </ng-option>
              </ng-select>
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">OWRM No 1</label>
              <input formControlName="owrmNo1" type="text" class="input-field" />
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">OWRM No 2</label>
              <input formControlName="owrmNo2" type="text" class="input-field" />
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Currency</label>
              <ng-select formControlName="currency2" class="input-field" placeholder="Select Currency">
                <ng-option *ngFor="let country of countryList" [value]="country.currencyName">
                  {{ country.currencyName }}
                </ng-option>
              </ng-select>
            </div>
          </div>
          <div class="col-lg-3 col-md-3">
            <div class="custom-form-input">
              <label for="">Payment Amount</label>
              <input formControlName="paymentAmount" type="number" class="input-field"
                (keypress)="validateNo1($event)" />
            </div>
          </div>
        </div>
      </div>

      <div id="Tab4" class="tab-pane fade show ">


        <div class="edit-screen-subTable mt-0">
          <h5>
            Sales Invoice
            <button (click)="createSalesDetailsGroup()" class="btn btn-sm btn-danger ms-2">Add</button>
          </h5>
        </div>

        <div class="custom-table">
          <table class="table table-sm table-bordered">
            <thead class="table-light text-center">
              <tr>
                <th style="width: 40px;">#</th>
                <th>Invoice Details</th>
                <th style="width: 50px;">Action</th>
              </tr>
            </thead>
            <tbody formArrayName="salesdetails">
              <ng-container *ngFor="let vendorGroup of salesDetails.controls; let ind = index">
                <tr [formGroupName]="ind">
                  <td class="align-top text-center">{{ ind + 1 }}</td>

                  <td>
                    <div class="row g-2">
                      <div class="col-md-3" *ngFor="let field of [
                  { label: 'Customer PO Number', name: 'customerPONo' },
                  { label: 'PO Value Inclusive Taxes', name: 'poValueInclusiveTaxes' },
                  { label: 'Professional Fee Invoice No', name: 'professionalFeeInvoiceNo' },
                  { label: 'Professional Fee Invoice Amount', name: 'professionalFeeInvoiceAmount' },
                  { label: 'Govt Fees Invoice No', name: 'govtFeesInvoiceNo' },
                  { label: 'Govt Fees Invoice Amount', name: 'govtFeesInvoiceAmount' },
                  { label: 'Official Fee Invoice Amount', name: 'officialFeeInvoiceAmount' },
                  { label: 'Our Invoice Number', name: 'ourInvoiceNo' },
                  { label: 'Invoice Amount', name: 'invoiceAmount' },
                  { label: 'Estimate No Prof Fee', name: 'estimateNoProfFee' },
                  { label: 'Estimate No Govt Fee', name: 'estimateNoGovtFee' },
                  { label: 'Remarks', name: 'remarks' }
                ]; let i = index">
                        <label class="label-small">{{ field.label }}</label>
                        <input [formControlName]="field.name" type="text"
                          class="form-control form-control-sm input-field-sm"  />
                      </div>

                      <!-- PO Date -->
                      <div class="col-sm-3">
                        <label class="label-small">PO Date</label>
                        <div class="input-group input-group-sm">
                          <input placeholder="yyyy-mm-dd" formControlName="poDate" class="form-control input-field-sm"
                            ngbDatepicker #poDate="ngbDatepicker" (dateSelect)="onDateSelect('poDate', $event)"
                            readonly />
                          <button class="btn btn-outline-secondary" (click)="poDate.toggle()" type="button">
                            <img src="assets/images/icons/calendar.svg" alt="" width="15px" />
                          </button>
                        </div>
                      </div>

                      <!-- Currency -->
                      <div class="col-sm-3">
                        <label class="label-small">Currency</label>
                        <div class="input-group input-group-sm">
                          <ng-select formControlName="currency3" class="ng-select-custom" [items]="countryList"
                            bindLabel="currencyName" placeholder="Select Currency" style="width: 100%;">
                          </ng-select>
                        </div>
                      </div>

                      <!-- Posted In Tally -->
                      <div class="col-sm-3">
                        <label class="label-small">Posted In Tally</label>
                        <div class="input-group input-group-sm">
                          <ng-select formControlName="postedInTally" class="ng-select-custom"
                            placeholder="Select Option" style="width: 100%;">
                            <ng-option [value]="'Yes'">Yes</ng-option>
                            <ng-option [value]="'No'">No</ng-option>
                          </ng-select>
                        </div>
                      </div>

                    </div>
                  </td>

                  <td class="text-center align-top">
                    <img src="assets/images/icons/trash.svg" alt="Delete"
                      (click)="onDeleteSalesDetail(vendorGroup, ind)" class="pointer" width="18px" />
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>


      </div>

    </div>
  </form>
</div>



<div class="spinner" *ngIf="loadSpinner">
  Loading...
</div>